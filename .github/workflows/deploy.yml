name: Deploy Frontend

on:
  push:
    branches: main 
  workflow_dispatch:

env:
  FRONTEND_IMAGE: millionmulugeta/frontend
  DOCKER_TAG: latest
  BUILD_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # Build Frontend
    - name: Build and push Frontend
      uses: docker/build-push-action@v5
      with:
        context: ./
        push: true
        tags: ${{ env.FRONTEND_IMAGE }}:${{ env.DOCKER_TAG }},${{ env.FRONTEND_IMAGE }}:${{ env.BUILD_TAG }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          NODE_ENV=production

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: 22
        script: |
          # Navigate to frontend directory
          cd ~/mrbeas/services/frontend
          
          # Create backup of current frontend
          echo "ğŸ“¦ Creating backup of current frontend..."
          if [ -d "frontend_backup" ]; then
            rm -rf frontend_backup
          fi
          cp -r . frontend_backup
          
          # Pull the latest frontend image
          echo "â¬‡ï¸ Pulling latest frontend Docker image..."
          docker pull ${{ env.FRONTEND_IMAGE }}:${{ env.DOCKER_TAG }}
          
          # Stop existing frontend container
          echo "ğŸ›‘ Stopping existing frontend container..."
          docker-compose down --timeout 30
          
          # Start new frontend container
          echo "ğŸš€ Starting new frontend container..."
          docker-compose up -d
          
          # Wait for container to start
          echo "â³ Waiting for frontend container to start..."
          sleep 15
          
          # Check container status
          echo "ğŸ“Š Frontend Container Status:"
          docker-compose ps
          
          # Health check
          echo "ğŸ¥ Running frontend health check..."
          
          # Check Frontend
          if curl -f -s http://localhost:5000 > /dev/null; then
            echo "âœ… Frontend health check passed"
          else
            echo "âŒ Frontend health check failed"
          fi
          
          # Show recent logs
          echo "ğŸ“‹ Recent frontend logs:"
          docker logs frontend --tail 10 || echo "No logs available for frontend"
          
          # Check if container is running
          FRONTEND_CONTAINER=$(docker-compose ps -q frontend)
          
          if [ -n "$FRONTEND_CONTAINER" ]; then
            echo "âœ… Frontend deployment successful! Container is running."
            echo "ğŸŒ Frontend available at: http://localhost:5000"
            
            # Clean up old backup if deployment successful
            echo "ğŸ§¹ Cleaning up old backup..."
            rm -rf frontend_backup
          else
            echo "âŒ Frontend deployment failed! Frontend container is not running."
            echo "ğŸ”„ Rolling back to previous frontend..."
            rm -rf ./*
            cp -r frontend_backup/* .
            docker-compose up -d
            exit 1
          fi

    - name: Notify deployment status
      if: always()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ğŸš€ **Frontend Deployment**
          
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Status:** ${{ job.status }}
          
          **Image Built:**
          â€¢ Frontend: ${{ env.FRONTEND_IMAGE }}:${{ env.DOCKER_TAG }}
          
          **Server:** ${{ secrets.SERVER_IP }}
          **Path:** ~/mrbeas/services/frontend
          
          ${{ job.status == 'success' && 'âœ… Frontend deployment successful! Available at http://localhost:5000' || 'âŒ Frontend deployment failed! Check logs for details.' }} 